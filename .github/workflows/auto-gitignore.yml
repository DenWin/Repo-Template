name: Auto-update .gitignore

on:
  push:
  pull_request:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: auto-gitignore-${{ github.ref }}
  cancel-in-progress: true

jobs:
  gitignore:
    runs-on: ubuntu-latest

    steps:
      # Pin checkout to a commit SHA (example uses v4.1.1 SHA). :contentReference[oaicite:0]{index=0}
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 1

      - name: Generate .gitignore (no commit here)
        id: gen
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          bash .github/scripts/update-gitignore.sh

      # Setup step: determine what actions to take based on context
      - name: Setup workflow decisions
        id: setup
        run: |
          # Determine if we should skip (already on auto-gitignore branch)
          should_skip="false"
          if [[ "${{ github.ref }}" == refs/heads/create-pull-request/auto-gitignore* ]]; then
            should_skip="true"
            echo "Skipping: already on auto-gitignore branch"
          fi
          echo "should_skip=$should_skip" >> $GITHUB_OUTPUT

          # Determine target branch (where PR should merge into)
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            target_branch="main"
          else
            # Extract branch name from refs/heads/branch-name
            target_branch="${{ github.ref#refs/heads/ }}"
          fi
          echo "target_branch=$target_branch" >> $GITHUB_OUTPUT

          # Determine actions needed
          should_fail_pr="false"
          should_create_pr="false"
          should_commit_direct="false"

          if [[ "${{ github.event_name }}" == "pull_request" && "${{ steps.gen.outputs.changed }}" == "true" ]]; then
            should_fail_pr="true"
          elif [[ "${{ github.event_name }}" == "push" && "${{ steps.gen.outputs.changed }}" == "true" && "$should_skip" == "false" ]]; then
            should_create_pr="true"
          fi

          echo "should_fail_pr=$should_fail_pr" >> $GITHUB_OUTPUT
          echo "should_create_pr=$should_create_pr" >> $GITHUB_OUTPUT
          echo "should_commit_direct=$should_commit_direct" >> $GITHUB_OUTPUT

      # For pull requests: enforce that .gitignore is current.
      - name: Fail PR if .gitignore would change
        if: ${{ steps.setup.outputs.should_fail_pr == 'true' }}
        run: |
          echo "::error::.gitignore is out of date. Run the workflow (or regenerate locally) and commit the updated .gitignore."
          echo
          echo "Diff:"
          git --no-pager diff -- .gitignore || true
          exit 1

      # For pushes: try to open/update an automated PR with the change.
      # If PR creation fails due to permissions, just commit directly to main.
      # Skip if we're already on an auto-gitignore branch to prevent infinite loops.
      - name: Create/update PR for .gitignore
        if: ${{ steps.setup.outputs.should_create_pr == 'true' }}
        id: create-pr
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
        continue-on-error: true
        with:
          commit-message: "chore: update .gitignore"
          title: "chore: update .gitignore"
          body: |
            Automated .gitignore refresh based on detected languages/frameworks and Toptal templates.
          branch: create-pull-request/auto-gitignore
          base: ${{ steps.setup.outputs.target_branch }}
          delete-branch: true
          add-paths: |
            .gitignore

      # Fallback: commit directly if PR creation failed
      - name: Commit .gitignore directly (PR creation failed)
        if: ${{ steps.setup.outputs.should_create_pr == 'true' && steps.create-pr.outcome == 'failure' }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .gitignore
          git commit -m "chore: update .gitignore"
          git push
