name: Auto-update .gitignore

on:
  push:
  pull_request:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: auto-gitignore-${{ github.ref }}
  cancel-in-progress: true

jobs:
  gitignore:
    runs-on: ubuntu-latest

    steps:
      # Pin checkout to a commit SHA (example uses v4.1.1 SHA). :contentReference[oaicite:0]{index=0}
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 1

      - name: Generate .gitignore (no commit here)
        id: gen
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          bash .github/scripts/update-gitignore.sh

      # For pull requests: enforce that .gitignore is current.
      - name: Fail PR if .gitignore would change
        if: ${{ github.event_name == 'pull_request' && steps.gen.outputs.changed == 'true' }}
        run: |
          echo "::error::.gitignore is out of date. Run the workflow (or regenerate locally) and commit the updated .gitignore."
          echo
          echo "Diff:"
          git --no-pager diff -- .gitignore || true
          exit 1

      # For pushes: try to open/update an automated PR with the change.
      # If PR creation fails due to permissions, just commit directly to main.
      - name: Create/update PR for .gitignore
        if: ${{ github.event_name == 'push' && steps.gen.outputs.changed == 'true' && !startsWith(github.ref, 'refs/heads/create-pull-request/') }}
        id: create-pr
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
        continue-on-error: true
        with:
          commit-message: "chore: update .gitignore"
          title: "chore: update .gitignore"
          body: |
            Automated .gitignore refresh based on detected languages/frameworks and Toptal templates.
          branch: create-pull-request/auto-gitignore
          delete-branch: true
          add-paths: |
            .gitignore

      # Fallback: commit directly if PR creation failed
      - name: Commit .gitignore directly (PR creation failed)
        if: ${{ github.event_name == 'push' && steps.gen.outputs.changed == 'true' && steps.create-pr.outcome == 'failure' }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .gitignore
          git commit -m "chore: update .gitignore"
          git push
